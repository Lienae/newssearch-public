<!-- templates/news/news-detail.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${news.title}">뉴스 상세</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="news-detail">
    <h2 th:text="${news.title}">제목</h2>
    <p th:text="${#temporals.format(news.publishDate, 'yyyy.MM.dd')} + ' | ' + ${news.mediaCompany}">날짜</p>
    <img th:src="${news.imageUrl}" alt="이미지" style="max-width:100%">
    <div th:text="${news.content}">본문</div>
</div>

<!-- 댓글 영역 추가 -->
<div class="comment-section" th:attr="data-news-id=${news.id}">
    <h3 id="commentCount">총 0개의 의견</h3>
    <form class="comment-form" id="commentForm">
        <input type="text" id="commentInput" placeholder="의견을 작성해주세요." required />
        <button type="submit">의견 등록</button>
    </form>
    <ul id="commentList"></ul>
</div>

<!-- 댓글 스크립트 추가 -->
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {
      const newsId = document.querySelector(".comment-section").dataset.newsId;
      const commentForm = document.getElementById("commentForm");
      const commentInput = document.getElementById("commentInput");
      console.log("input:", commentInput);
      const commentList = document.getElementById("commentList");
      const commentCount = document.getElementById("commentCount");

      // 댓글 등록
      commentForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const content = commentInput.value.trim();
        if (!content) return;

        console.log("보내는 newsId:", newsId);
        console.log("보내는 content:", content);

        const res = await fetch("/api/v1/comment/create", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ newsId: newsId, content: content })
        });
        console.log("응답 상태:", res.status);
        });

        if (res.ok) {
          commentInput.value = "";
          loadComments();
        }
      });

      // 댓글 불러오기
      async function loadComments() {
        const res = await fetch(`/api/v1/comment/list?newsId=${newsId}`);
        if (!res.ok) return;

        const comments = await res.json();
        commentList.innerHTML = "";

        comments.forEach(c => {
          const li = document.createElement("li");
          li.innerText = `${c.writerEmail} : ${c.content}`;
          commentList.appendChild(li);
        });

        commentCount.innerText = `총 ${comments.length}개의 의견`;
      }

      loadComments();
    });
</script>
</body>
</html>